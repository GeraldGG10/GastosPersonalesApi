<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Test Token</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
    .success { color: #0f0; }
    .error { color: #f00; }
    .info { color: #ff0; }
    pre { background: #000; padding: 10px; border: 1px solid #0f0; }
  </style>
</head>
<body>
  <h1>üîç Diagn√≥stico de Token</h1>
  <div id="output"></div>

  <script src="js/api.js"></script>
  <script>
    const output = document.getElementById("output");
    
    function log(msg, type = "info") {
      const div = document.createElement("div");
      div.className = type;
      div.innerHTML = msg;
      output.appendChild(div);
    }

    async function testToken() {
      log("<h2>1. Verificando localStorage</h2>");
      const token = localStorage.getItem("token");
      
      if (!token) {
        log("‚ùå NO HAY TOKEN en localStorage", "error");
        log("<br><button onclick='location.href=\"index.html\"'>Ir a Login</button>");
        return;
      }
      
      log("‚úì Token encontrado en localStorage", "success");
      log(`<pre>Token: ${token.substring(0, 50)}...${token.substring(token.length - 20)}</pre>`);
      log(`<pre>Longitud: ${token.length} caracteres</pre>`);
      
      // Decodificar JWT (solo la parte del payload)
      try {
        const parts = token.split('.');
        if (parts.length === 3) {
          const payload = JSON.parse(atob(parts[1]));
          log("<h3>Payload del token:</h3>");
          log(`<pre>${JSON.stringify(payload, null, 2)}</pre>`, "info");
          
          // Verificar expiraci√≥n
          if (payload.exp) {
            const exp = new Date(payload.exp * 1000);
            const now = new Date();
            log(`<p>Expira: ${exp.toLocaleString()}</p>`);
            log(`<p>Ahora: ${now.toLocaleString()}</p>`);
            
            if (exp < now) {
              log("‚ùå TOKEN EXPIRADO", "error");
            } else {
              log("‚úì Token v√°lido (no expirado)", "success");
            }
          }
        }
      } catch (e) {
        log(`‚ö† No se pudo decodificar el token: ${e.message}`, "error");
      }

      log("<h2>2. Probando endpoints del backend</h2>");
      
      // Test 1: Profile (deber√≠a funcionar si el token es v√°lido)
      log("<h3>Test: GET /api/Auth/profile</h3>");
      try {
        const profileRes = await apiFetch("/Auth/profile");
        if (profileRes) {
          log("‚úì Profile endpoint respondi√≥ correctamente", "success");
          log(`<pre>${JSON.stringify(profileRes, null, 2)}</pre>`);
        } else {
          log("‚ùå Profile endpoint retorn√≥ null (posible 401)", "error");
        }
      } catch (e) {
        log(`‚ùå Error en profile: ${e.message}`, "error");
      }

      // Test 2: Expenses
      log("<h3>Test: GET /api/Expenses</h3>");
      try {
        const expensesRes = await apiFetch("/Expenses");
        if (expensesRes) {
          log("‚úì Expenses endpoint respondi√≥ correctamente", "success");
          log(`<pre>Cantidad de gastos: ${Array.isArray(expensesRes) ? expensesRes.length : 'N/A'}</pre>`);
        } else {
          log("‚ùå Expenses endpoint retorn√≥ null (posible 401)", "error");
        }
      } catch (e) {
        log(`‚ùå Error en expenses: ${e.message}`, "error");
      }

      // Test 3: Categories
      log("<h3>Test: GET /api/Categories</h3>");
      try {
        const categoriesRes = await apiFetch("/Categories");
        if (categoriesRes) {
          log("‚úì Categories endpoint respondi√≥ correctamente", "success");
          log(`<pre>Cantidad de categor√≠as: ${Array.isArray(categoriesRes) ? categoriesRes.length : 'N/A'}</pre>`);
        } else {
          log("‚ùå Categories endpoint retorn√≥ null (posible 401)", "error");
        }
      } catch (e) {
        log(`‚ùå Error en categories: ${e.message}`, "error");
      }

      log("<h2>3. Verificar en la pesta√±a Network</h2>");
      log("<p>Abre DevTools (F12) ‚Üí Network ‚Üí Busca las peticiones anteriores</p>");
      log("<p>Para cada petici√≥n fallida, verifica:</p>");
      log("<ul><li>Status code (debe ser 200, si es 401 = token inv√°lido)</li>");
      log("<li>Request Headers ‚Üí Authorization (debe tener 'Bearer ...')</li>");
      log("<li>Response (qu√© dice el servidor)</li></ul>");
    }

    testToken();
  </script>
</body>
</html>